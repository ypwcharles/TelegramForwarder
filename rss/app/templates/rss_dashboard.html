<!DOCTYPE html>
<html>
<head>
    <title>TG Forwarder RSS 管理</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #2c3e50;
        }
        
        .navbar {
            background: rgba(0, 0, 0, 0.3) !important;
            backdrop-filter: blur(10px);
            border: none;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
            backdrop-filter: blur(10px);
            background: transparent;
            margin-bottom: 20px;
            opacity: 0;
            animation: fadeIn 0.3s ease forwards;
            padding-bottom: 0;
        }

        .card-body {
            padding: 0;
        }

        .modal-content {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.98);
        }

        .btn {
            border-radius: 10px;
            padding: 8px 16px;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(to right, #667eea, #764ba2);
            border: none;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(0,0,0,0.18), 0 5px 5px rgba(0,0,0,0.12);
            background: linear-gradient(to right, #5a6fd6, #684291);
        }

        .form-control, .form-select {
            border-radius: 10px;
            padding: 12px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
            background-color: rgba(255, 255, 255, 0.9);
        }

        .form-control:focus, .form-select:focus {
            border-color: #764ba2;
            box-shadow: 0 0 0 0.2rem rgba(118,75,162,0.25);
            background-color: #ffffff;
        }

        .table {
            border-radius: 10px;
            overflow: hidden;
            background-color: #ffffff;
            table-layout: fixed;
            width: 100%;
            margin-bottom: 0;
            border-bottom: none;
            border: none !important;
        }

        /* 重新设置各列宽度比例 */
        .table th:nth-child(1), 
        .table td:nth-child(1) {
            width: 5%;
            text-align: center;
        }
        
        .table th:nth-child(2), 
        .table td:nth-child(2) {
            width: 8%;
            text-align: center;
        }
        
        .table th:nth-child(3), 
        .table td:nth-child(3) {
            width: 12%;
            text-align: center;
        }
        
        .table th:nth-child(4), 
        .table td:nth-child(4) {
            width: 12%;
            text-align: center;
        }
        
        .table th:nth-child(5), 
        .table td:nth-child(5) {
            width: 8%;
            text-align: center;
        }
        
        .table th:nth-child(6), 
        .table td:nth-child(6) {
            width: 30%;
            text-align: center;
        }
        
        .table th:nth-child(7), 
        .table td:nth-child(7) {
            width: 25%;
            text-align: center;
        }

        .table th,
        .table td {
            vertical-align: middle;
            text-align: center;
            padding: 0.8rem 0.3rem;
            overflow: hidden;
        }

        .btn-group {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .rss-link {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .rss-link-text {
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            color: #2c5282;
            transition: all 0.2s ease;
            font-family: monospace;
            font-size: 0.85em;
            background: rgba(66, 153, 225, 0.1);
            padding: 6px 8px;
            border-radius: 4px;
            width: 90%;
            display: block;
            text-align: center;
            text-decoration: none;
        }

        .rss-link-text:hover {
            background: rgba(66, 153, 225, 0.2);
            color: #1a365d;
            text-decoration: none;
        }

        .copy-btn {
            cursor: pointer;
            width: 10%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(66, 153, 225, 0.1);
            border-radius: 4px;
            padding: 6px 0;
            transition: all 0.2s ease;
        }

        .copy-btn:hover {
            background: rgba(66, 153, 225, 0.2);
        }

        .copy-btn i {
            font-size: 0.9em;
            color: #2c5282;
        }

        .table .badge {
            display: inline-block;
            width: 80%;
            text-align: center;
        }

        /* 为了保持表头和表格内容一致 */
        .table thead th {
            background-color: rgba(118,75,162,0.1);
            color: #2c3e50;
            font-weight: 600;
            border-bottom: 2px solid rgba(118,75,162,0.2);
            text-align: center !important;
            white-space: nowrap;
        }

        /* 统一行中各项布局 */
        .table tbody tr {
            border-bottom: 1px solid rgba(118,75,162,0.1);
        }

        .table tbody tr:last-child {
            border-bottom: none;
        }

        /* 优化文本截断效果 */
        .text-truncate {
            max-width: 95% !important;
            display: inline-block;
            vertical-align: middle;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 为名称和描述添加特殊样式 */
        .name-cell, .desc-cell {
            padding: 0.5rem 0.3rem !important;
            font-size: 0.9rem;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 500;
        }

        .alert {
            border-radius: 10px;
            border: none;
            animation: slideDownSmall 0.5s ease forwards;
            background-color: rgba(255, 255, 255, 0.95);
        }

        .container h2 {
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-weight: 600;
            margin-bottom: 1rem;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        @keyframes slideDownSmall {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .nav-tabs {
            border-bottom: 2px solid rgba(118,75,162,0.2);
        }

        .nav-tabs .nav-link {
            border: none;
            color: #4a5568;
            padding: 10px 20px;
            margin-right: 4px;
            border-radius: 10px 10px 0 0;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-tabs .nav-link:hover {
            background: rgba(118,75,162,0.1);
            color: #2d3748;
        }

        .nav-tabs .nav-link.active {
            color: #764ba2;
            background: rgba(118,75,162,0.1);
            border-bottom: 2px solid #764ba2;
            font-weight: 600;
        }

        .form-check-input:checked {
            background-color: #764ba2;
            border-color: #764ba2;
        }

        .table-responsive {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: none;
            background-color: rgba(255, 255, 255, 0.9);
            border: none !important;
        }

        .btn-group {
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .btn-group .btn {
            border-radius: 0;
        }

        .btn-group .btn:first-child {
            border-top-left-radius: 10px;
            border-bottom-left-radius: 10px;
        }

        .btn-group .btn:last-child {
            border-top-right-radius: 10px;
            border-bottom-right-radius: 10px;
        }

        .form-label {
            color: #2d3748;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .modal-title {
            color: #2d3748;
            font-weight: 600;
        }

        .modal-header {
            border-bottom: 1px solid rgba(118,75,162,0.2);
        }

        .modal-footer {
            border-top: 1px solid rgba(118,75,162,0.2);
        }

        .table th:first-child,
        .table td:first-child {
            text-align: center;
        }

        .btn-warning {
            background-color: #f6ad55;
            border: none;
            color: #ffffff;
        }

        .btn-warning:hover {
            background-color: #ed8936;
            color: #ffffff;
        }

        .btn-success {
            background-color: #48bb78;
            border: none;
        }

        .btn-success:hover {
            background-color: #38a169;
        }

        .btn-danger {
            background-color: #f56565;
            border: none;
        }

        .btn-danger:hover {
            background-color: #e53e3e;
        }

        .badge.bg-success {
            background-color: #48bb78 !important;
        }

        .badge.bg-secondary {
            background-color: #718096 !important;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .navbar-brand svg {
            width: 24px;
            height: 24px;
            stroke: currentColor;
        }

        .btn-create {
            background: linear-gradient(to right, #38b2ac, #4299e1);
            color: white;
            padding: 12px 24px;
            font-size: 1rem;
            box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: none;
        }

        .btn-create:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
            background: linear-gradient(to right, #319795, #3182ce);
            color: white;
        }

        .btn-create i {
            margin-right: 8px;
            font-size: 1.1em;
        }

        .copy-success {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(72, 187, 120, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .copy-success.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* 移除表格底部的线条 */
        .card-body {
            /* padding-bottom: 0; */
        }
        
        /* 移除可能的表格边框 */
        .table-striped {
            border: none !important;
        }
        
        .table thead, 
        .table tbody, 
        .table tfoot, 
        .table tr, 
        .table th, 
        .table td {
            border-bottom-color: rgba(118,75,162,0.1);
        }
        
        /* 为卡片底部添加额外的内边距，维持整体平衡感 */
        .card {
            /* padding-bottom: 0.5rem; */
            padding-bottom: 0;
        }

        /* 禁用状态的链接样式 */
        .disabled-link {
            color: #a0aec0 !important;
            background: rgba(160, 174, 192, 0.1) !important;
            cursor: not-allowed;
            text-decoration: none;
            opacity: 0.7;
        }
        
        .disabled-link:hover {
            background: rgba(160, 174, 192, 0.1) !important;
            color: #a0aec0 !important;
        }

        /* 确保折叠区域在展开时保持正确的样式 */
        .collapse.show {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
        }
        
        /* 增强测试区域卡片样式 */
        #regexTestArea .card {
            background-color: rgba(255, 255, 255, 0.95) !important;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 1 !important;
            animation: none !important;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(118,75,162,0.1);
        }
        
        #regexTestArea .card-body {
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.95);
        }
        
        #regexTestArea .form-control,
        #regexTestArea .form-select {
            background-color: #ffffff;
            border: 1px solid rgba(118,75,162,0.2);
        }
        
        #regexTestArea .btn {
            padding: 8px 16px;
        }
        
        #regexTestArea .alert {
            margin-top: 10px;
            margin-bottom: 10px;
        }
        
        /* 确保正则表达式结果区域样式正确 */
        #regex_test_result {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 12px 15px;
        }
        
        /* 应用按钮样式 */
        #apply_regex_btn {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/rss/dashboard">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                </svg>
                TG Forwarder RSS
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/Heavrnl/TelegramForwarder" target="_blank">
                            <i class="bi bi-github"></i> GitHub
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                            <i class="bi bi-key"></i> 修改密码
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/logout">退出登录</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
        {% endif %}

        {% if success %}
        <div class="alert alert-success">{{ success }}</div>
        {% endif %}

        <!-- 配置列表 -->
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center">
                    <h2>RSS 配置列表</h2>
                    <button class="btn btn-create animate__animated animate__fadeIn" data-bs-toggle="modal" data-bs-target="#configModal" onclick="clearForm()">
                        <i class="bi bi-plus-circle"></i>
                        新建配置
                    </button>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>规则ID</th>
                                <th>规则名称</th>
                                <th>描述</th>
                                <th>状态</th>
                                <th>RSS链接</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for config in rss_configs %}
                            <tr>
                                <td>{{ config.id }}</td>
                                <td>{{ config.rule_id }}</td>
                                <td class="name-cell"><span class="text-truncate">{{ config.rule_title or "未命名" }}</span></td>
                                <td class="desc-cell"><span class="text-truncate">{{ config.rule_description or "无描述" }}</span></td>
                                <td>
                                    {% if config.enable_rss %}
                                    <span class="badge bg-success">已启用</span>
                                    {% else %}
                                    <span class="badge bg-secondary">已禁用</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if config.enable_rss %}
                                    <div class="rss-link">
                                        <a href="/rss/feed/{{ config.rule_id }}" target="_blank" 
                                           class="rss-link-text" id="rss-link-{{ config.rule_id }}" title="点击访问">
                                            /rss/feed/{{ config.rule_id }}
                                        </a>
                                        <span class="copy-btn" onclick="copyFullRssLink('{{ config.rule_id }}')" title="复制链接">
                                            <i class="bi bi-clipboard"></i>
                                        </span>
                                    </div>
                                    {% else %}
                                    <div class="rss-link">
                                        <span class="rss-link-text disabled-link" id="rss-link-{{ config.rule_id }}" title="RSS已禁用">
                                            /rss/feed/{{ config.rule_id }}
                                        </span>
                                        <span class="copy-btn" onclick="copyFullRssLink('{{ config.rule_id }}')" title="复制链接">
                                            <i class="bi bi-clipboard"></i>
                                        </span>
                                    </div>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-primary" onclick="editConfig('{{ config.id }}', '{{ config.rule_id }}')">
                                            <i class="bi bi-gear"></i> 编辑
                                        </button>
                                        <a href="/rss/toggle/{{ config.rule_id }}" class="btn btn-sm {% if config.enable_rss %}btn-warning{% else %}btn-success{% endif %}">
                                            {% if config.enable_rss %}
                                            <i class="bi bi-pause-fill"></i> 禁用
                                            {% else %}
                                            <i class="bi bi-play-fill"></i> 启用
                                            {% endif %}
                                        </a>
                                        <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal" data-id="{{ config.id }}" data-rule-id="{{ config.rule_id }}">
                                            <i class="bi bi-trash"></i> 删除
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="7" class="text-center">暂无 RSS 配置</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑/创建配置模态框 -->
    <div class="modal fade" id="configModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="configModalTitle">编辑 RSS 配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="configForm" method="post" action="/rss/config">
                        <input type="hidden" id="config_id" name="config_id">
                        
                        <div class="mb-3" id="rule_id_container">
                            <label for="rule_id" class="form-label">规则 ID</label>
                            <select class="form-select" id="rule_id" name="rule_id" required>
                                <option value="">请选择规则</option>
                                {% for rule in rules %}
                                <option value="{{ rule.id }}">{{ rule.id }} - {{ rule.source_chat.name }} → {{ rule.target_chat.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- 添加复制配置功能 -->
                        <div class="mb-3 border-bottom pb-3">
                            <div class="row align-items-end">
                                <div class="col-md-8">
                                    <label for="copy_config" class="form-label">复制已有配置</label>
                                    <select class="form-select" id="copy_config">
                                        <option value="">选择一个配置复制其设置</option>
                                        {% for config in rss_configs %}
                                        <option value="{{ config.id }}">{{ config.rule_id }} - {{ config.rule_title or "未命名" }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-info w-100" onclick="copyConfigSettings()">
                                        <i class="bi bi-clipboard"></i> 复制设置
                                    </button>
                                </div>
                            </div>
                            <div class="form-text text-muted mt-2">复制操作只会填充表单，需要点击保存才会生效</div>
                        </div>

                        <div class="mb-3">
                            <label for="rule_title" class="form-label">订阅源标题</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="rule_title" name="rule_title">
                                <button type="button" class="btn btn-outline-secondary" onclick="autoFillTitle()" title="自动填充标题">
                                    <i class="bi bi-magic"></i> 自动填充
                                </button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="rule_description" class="form-label">订阅源描述</label>
                            <textarea class="form-control" id="rule_description" name="rule_description" rows="3"></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="language" class="form-label">语言</label>
                                <input type="text" class="form-control" id="language" name="language" value="zh-CN">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="max_items" class="form-label">最大条目数</label>
                                <input type="number" class="form-control" id="max_items" name="max_items" value="50">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">内容处理选项</label>
                            <div class="border rounded p-3">
                                <!-- AI提取选项 -->
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="is_ai_extract" name="is_ai_extract" onchange="handleAIExtractChange()">
                                        <label class="form-check-label" for="is_ai_extract">使用 AI 提取标题和内容</label>
                                    </div>
                                </div>
                                
                                <!-- 其他自动提取选项 -->
                                <div id="normalExtractOptions">
                                    <div class="mb-2">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input normal-extract" type="checkbox" id="is_auto_title" name="is_auto_title" onchange="handleNormalExtractChange()">
                                            <label class="form-check-label" for="is_auto_title">自动提取标题</label>
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input normal-extract" type="checkbox" id="is_auto_content" name="is_auto_content" onchange="handleNormalExtractChange()">
                                            <label class="form-check-label" for="is_auto_content">自动提取内容</label>
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input normal-extract" type="checkbox" id="is_auto_markdown_to_html" name="is_auto_markdown_to_html" onchange="handleNormalExtractChange()">
                                            <label class="form-check-label" for="is_auto_markdown_to_html">自动将 Markdown 转换为 HTML</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="ai_extract_prompt" class="form-label">AI 提取提示词</label>
                            <textarea class="form-control" id="ai_extract_prompt" name="ai_extract_prompt" rows="3"></textarea>
                        </div>

                        <script>
                            // 处理AI提取选项变化
                            function handleAIExtractChange() {
                                const isAIExtract = document.getElementById('is_ai_extract').checked;
                                const normalExtractInputs = document.querySelectorAll('.normal-extract');
                                
                                // 如果启用AI提取，禁用其他选项
                                normalExtractInputs.forEach(input => {
                                    input.checked = false;
                                    input.disabled = isAIExtract;
                                });
                                
                                // 同时禁用自定义正则表达式提取选项
                                const customTitlePattern = document.getElementById('enable_custom_title_pattern');
                                const customContentPattern = document.getElementById('enable_custom_content_pattern');
                                
                                customTitlePattern.checked = false;
                                customContentPattern.checked = false;
                                customTitlePattern.disabled = isAIExtract;
                                customContentPattern.disabled = isAIExtract;
                            }
                            
                            // 处理普通提取选项变化
                            function handleNormalExtractChange() {
                                const normalExtractInputs = document.querySelectorAll('.normal-extract');
                                const isAnyNormalChecked = Array.from(normalExtractInputs).some(input => input.checked);
                                
                                // 如果有任何普通选项被选中，禁用AI提取
                                const aiExtract = document.getElementById('is_ai_extract');
                                if (isAnyNormalChecked) {
                                    aiExtract.checked = false;
                                }
                            }
                            
                            // 处理自定义正则提取选项变化
                            function handleCustomExtractChange() {
                                const customTitlePattern = document.getElementById('enable_custom_title_pattern');
                                const customContentPattern = document.getElementById('enable_custom_content_pattern');
                                const isAnyCustomChecked = customTitlePattern.checked || customContentPattern.checked;
                                
                                // 如果有任何自定义正则选项被选中，禁用AI提取
                                const aiExtract = document.getElementById('is_ai_extract');
                                if (isAnyCustomChecked) {
                                    aiExtract.checked = false;
                                }
                            }
                        </script>

                        <!-- 添加正则表达式模式管理部分 -->
                        <div class="border rounded p-3 mb-3">
                            <h5 class="mb-3">正则表达式配置</h5>
                            
                            <!-- 添加自定义模式启用开关 -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enable_custom_title_pattern" name="enable_custom_title_pattern" onchange="handleCustomExtractChange()">
                                        <label class="form-check-label" for="enable_custom_title_pattern">启用自定义标题提取正则表达式</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enable_custom_content_pattern" name="enable_custom_content_pattern" onchange="handleCustomExtractChange()">
                                        <label class="form-check-label" for="enable_custom_content_pattern">启用自定义内容提取正则表达式</label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 新模式输入区域 -->
                            <div class="row mb-3">
                                <div class="col-md-5">
                                    <label for="new_pattern" class="form-label">正则表达式</label>
                                    <input type="text" class="form-control" id="new_pattern" placeholder="例如: ^#[^\s]+\s+\*\*([^*]+?)\*\*">
                                </div>
                                <div class="col-md-3">
                                    <label for="new_pattern_type" class="form-label">类型</label>
                                    <select class="form-select" id="new_pattern_type">
                                        <option value="title">标题</option>
                                        <option value="content">内容</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="new_priority" class="form-label">优先级</label>
                                    <input type="number" class="form-control" id="new_priority" value="0">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="button" class="btn btn-primary w-100" onclick="addPattern()">
                                        <i class="bi bi-plus-circle"></i> 添加
                                    </button>
                                </div>
                            </div>
                            <div class="form-text text-muted mb-3">优先级说明：数字越低优先级越高，越先执行</div>
                            
                            <!-- 正则表达式测试区域 -->
                            <div class="mb-3">
                                <button class="btn btn-sm btn-outline-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#regexTestArea" aria-expanded="false" aria-controls="regexTestArea">
                                    <i class="bi bi-check-circle"></i> 展开正则表达式测试区域
                                </button>
                                
                                <div class="collapse mt-3" id="regexTestArea">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title fw-bold mb-3">正则表达式测试</h6>
                                            <p class="text-muted small mb-4">在这里输入示例文本并测试您的正则表达式是否能正确匹配并提取内容</p>
                                            
                                            <div class="mb-3">
                                                <label for="regex_test_text" class="form-label fw-medium">测试文本</label>
                                                <textarea class="form-control" id="regex_test_text" rows="4" placeholder="输入要测试的文本..."></textarea>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-8">
                                                    <label for="regex_test_pattern" class="form-label fw-medium">正则表达式</label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" id="regex_test_pattern" placeholder="输入要测试的正则表达式">
                                                        <select class="form-select" id="regex_test_type" style="max-width: 120px;">
                                                            <option value="title">标题提取</option>
                                                            <option value="content">内容提取</option>
                                                        </select>
                                                    </div>
                                                    <div class="form-text">记得使用括号 () 创建捕获组来提取内容</div>
                                                </div>
                                                <div class="col-md-4 d-flex align-items-center">
                                                    <button type="button" class="btn btn-primary w-100" onclick="testRegex()" style="margin-top: 5px;">
                                                        <i class="bi bi-lightning"></i> 测试正则表达式
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div id="regex_test_result" class="alert alert-info" style="display: none;">
                                                测试结果将显示在这里
                                            </div>
                                            
                                            <div class="d-flex justify-content-end">
                                                <button type="button" class="btn btn-sm btn-success" onclick="applyTestedRegex()" id="apply_regex_btn" style="display: none;">
                                                    <i class="bi bi-check2"></i> 应用到输入框
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 使用标签页分开显示标题模式和内容模式 -->
                            <ul class="nav nav-tabs mb-3" id="patternsTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="title-patterns-tab" data-bs-toggle="tab" data-bs-target="#title-patterns" type="button" role="tab" aria-controls="title-patterns" aria-selected="true">标题模式</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="content-patterns-tab" data-bs-toggle="tab" data-bs-target="#content-patterns" type="button" role="tab" aria-controls="content-patterns" aria-selected="false">内容模式</button>
                                </li>
                            </ul>
                            <div class="tab-content" id="patternsTabContent">
                                <!-- 标题模式表格 -->
                                <div class="tab-pane fade show active" id="title-patterns" role="tabpanel" aria-labelledby="title-patterns-tab">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped">
                                            <thead>
                                                <tr>
                                                    <th>模式</th>
                                                    <th>优先级</th>
                                                    <th>操作</th>
                                                </tr>
                                            </thead>
                                            <tbody id="title_patterns_list">
                                                <!-- 标题模式列表会通过JS动态加载 -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div id="no_title_patterns_message" class="text-center py-2">
                                        <p class="text-muted mb-0">暂无标题模式配置</p>
                                    </div>
                                </div>
                                
                                <!-- 内容模式表格 -->
                                <div class="tab-pane fade" id="content-patterns" role="tabpanel" aria-labelledby="content-patterns-tab">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped">
                                            <thead>
                                                <tr>
                                                    <th>模式</th>
                                                    <th>优先级</th>
                                                    <th>操作</th>
                                                </tr>
                                            </thead>
                                            <tbody id="content_patterns_list">
                                                <!-- 内容模式列表会通过JS动态加载 -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div id="no_content_patterns_message" class="text-center py-2">
                                        <p class="text-muted mb-0">暂无内容模式配置</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveConfig()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">确认删除</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    确定要删除这个 RSS 配置吗？此操作不可撤销。
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <a href="#" id="deleteConfirm" class="btn btn-danger">删除</a>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改密码模态框 -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">修改密码</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm" method="post" action="/rss/change_password">
                        <div class="mb-3">
                            <label for="current_password" class="form-label">当前密码</label>
                            <input type="password" class="form-control" id="current_password" name="current_password" required>
                        </div>
                        <div class="mb-3">
                            <label for="new_password" class="form-label">新密码</label>
                            <input type="password" class="form-control" id="new_password" name="new_password" required>
                            <div class="form-text">密码长度至少为8个字符</div>
                        </div>
                        <div class="mb-3">
                            <label for="confirm_password" class="form-label">确认新密码</label>
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                        </div>
                        <div id="password_error" class="alert alert-danger" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="changePassword()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <div id="copySuccess" class="copy-success">
        已复制 RSS 链接到剪贴板
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 配置数据 - 使用JSON直接传递数据
        let configs;
        try {
            // 解析配置数据
            configs = JSON.parse('{{ rss_configs|tojson }}');
            console.log('初始化时加载的配置数据:', configs);
            
            // 处理每个配置中的Base64编码字段
            configs.forEach(config => {
                if (config.ai_extract_prompt && config.ai_extract_prompt.startsWith('BASE64:')) {
                    try {
                        // 解码Base64内容 - 使用支持UTF-8的解码方法
                        const base64Content = config.ai_extract_prompt.substring(7); // 移除 'BASE64:' 前缀
                        
                        // 自定义Base64解码函数，支持UTF-8
                        function base64DecodeUnicode(str) {
                            // 转换base64为二进制字符串
                            const binaryStr = atob(str);
                            // 创建Uint8Array来存储每个字符的UTF-8编码
                            const bytes = new Uint8Array(binaryStr.length);
                            for (let i = 0; i < binaryStr.length; i++) {
                                bytes[i] = binaryStr.charCodeAt(i);
                            }
                            // 解码为UTF-8字符串
                            return new TextDecoder().decode(bytes);
                        }
                        
                        const decodedContent = base64DecodeUnicode(base64Content);
                        config.ai_extract_prompt = decodedContent;
                        console.log('成功解码AI提取提示词');
                    } catch (decodeError) {
                        console.error('解码Base64内容失败:', decodeError);
                        config.ai_extract_prompt = '（提示词内容无法正确显示）';
                    }
                }
            });
        } catch (error) {
            console.error('解析配置数据失败:', error);
            console.error('原始JSON字符串:', '{{ rss_configs|tojson }}'.substring(0, 200) + '...');
            // 设置为空数组，防止页面出错
            configs = [];
            alert('加载配置数据时出错，请刷新页面或联系管理员');
        }
        
        let currentPatterns = []; // 当前编辑的配置的模式列表

        // 编辑配置
        function editConfig(id, ruleId) {
            // 添加调试日志
            console.log('点击编辑按钮，参数:', { id, ruleId });
            
            // 将字符串参数转换为数字
            id = parseInt(id);
            ruleId = parseInt(ruleId);
            
            console.log('转换为数字后的参数:', { id, ruleId });
            
            const config = configs.find(c => c.id === id);
            console.log('查找到的配置:', config);
            
            if (config) {
                console.log('开始设置表单值...');
                document.getElementById('configModalTitle').textContent = '编辑 RSS 配置';
                document.getElementById('config_id').value = config.id;
                document.getElementById('rule_id').value = config.rule_id;
                document.getElementById('rule_id').disabled = true;
                document.getElementById('rule_title').value = config.rule_title;
                document.getElementById('rule_description').value = config.rule_description;
                document.getElementById('language').value = config.language;
                document.getElementById('max_items').value = config.max_items;
                document.getElementById('is_auto_title').checked = config.is_auto_title;
                document.getElementById('is_auto_content').checked = config.is_auto_content;
                document.getElementById('is_auto_markdown_to_html').checked = config.is_auto_markdown_to_html;
                document.getElementById('is_ai_extract').checked = config.is_ai_extract;
                
                // 设置AI提取提示词，已经在JSON解析阶段处理了Base64编码
                document.getElementById('ai_extract_prompt').value = config.ai_extract_prompt || '';
                
                document.getElementById('enable_custom_title_pattern').checked = config.enable_custom_title_pattern;
                document.getElementById('enable_custom_content_pattern').checked = config.enable_custom_content_pattern;
                console.log('表单值已设置完成');
                
                // 显示模态框
                try {
                    console.log('准备显示模态框...');
                    const modalElement = document.getElementById('configModal');
                    console.log('找到模态框元素:', modalElement);
                    const modal = new bootstrap.Modal(modalElement);
                    console.log('创建了Bootstrap Modal对象');
                    modal.show();
                    console.log('模态框已显示');
                } catch (error) {
                    console.error('显示模态框时出错:', error);
                }
                
                // 加载该配置的模式
                console.log('准备加载配置模式, configId:', id);
                loadPatternsForConfig(id);
            } else {
                console.error('未找到相应的配置, id:', id);
            }
        }

        // 清空表单，用于创建新配置
        function clearForm() {
            document.getElementById('configModalTitle').textContent = '创建 RSS 配置';
            document.getElementById('config_id').value = '';
            document.getElementById('rule_id').disabled = false;
            document.getElementById('rule_id').selectedIndex = 0;
            document.getElementById('rule_title').value = '';
            document.getElementById('rule_description').value = '';
            document.getElementById('language').value = 'zh-CN';
            document.getElementById('max_items').value = 50;
            document.getElementById('is_auto_title').checked = false;
            document.getElementById('is_auto_content').checked = false;
            document.getElementById('is_auto_markdown_to_html').checked = false;
            document.getElementById('is_ai_extract').checked = false;
            document.getElementById('ai_extract_prompt').value = '请按照以下要求从消息文本中提取标题和正文内容：\n1. 若文本中已有明确标题，则直接提取；否则根据正文生成合适标题；\n2. 若原文为 Markdown 格式，请先转换为 HTML 格式后再提取；\n3. 最终输出必须为标准 JSON 格式，如下：\n{ "title": "提取或生成的标题", "content": "提取后的正文内容（HTML 格式），要去掉标题" }\n请仅返回上述 JSON 格式，不得包含其他任何内容或代码块。以下是消息内容：';
            document.getElementById('enable_custom_title_pattern').checked = false;
            document.getElementById('enable_custom_content_pattern').checked = false;
            
            // 清空模式列表
            currentPatterns = [];
            renderPatternsList();
            
            // 禁用已经有配置的规则ID选项
            disableConfiguredRules();
        }
        
        // 禁用已经有配置的规则ID选项
        function disableConfiguredRules() {
            // 获取所有已配置的规则ID
            const configuredRuleIds = configs.map(config => config.rule_id);
            
            // 获取规则选择下拉框中的所有选项
            const ruleOptions = document.getElementById('rule_id').options;
            
            // 保存原始选项文本，如果尚未保存
            if (!window.originalOptionTexts) {
                window.originalOptionTexts = {};
                for (let i = 0; i < ruleOptions.length; i++) {
                    const option = ruleOptions[i];
                    window.originalOptionTexts[option.value] = option.text;
                }
            }
            
            // 遍历所有选项，禁用已配置的规则ID
            for (let i = 0; i < ruleOptions.length; i++) {
                const option = ruleOptions[i];
                const ruleId = parseInt(option.value);
                const originalText = window.originalOptionTexts[option.value];
                
                // 先恢复原始文本
                if (originalText) {
                    option.text = originalText;
                }
                
                // 如果是已配置的规则ID且不是空值，则禁用该选项
                if (ruleId && configuredRuleIds.includes(ruleId)) {
                    option.disabled = true;
                    option.text = option.text + ' (已配置)';
                } else {
                    option.disabled = false;
                }
            }
        }
        
        // 加载特定配置的所有模式
        function loadPatternsForConfig(configId) {
            if (!configId) {
                currentPatterns = [];
                renderPatternsList();
                return;
            }
            
            fetch(`/rss/patterns/${configId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.patterns) {
                        currentPatterns = data.patterns;
                    } else {
                        currentPatterns = [];
                    }
                    renderPatternsList();
                })
                .catch(error => {
                    console.error('加载模式失败:', error);
                    currentPatterns = [];
                    renderPatternsList();
                });
        }
        
        // 渲染模式列表
        function renderPatternsList() {
            // 分离标题和内容模式
            const titlePatterns = currentPatterns.filter(p => p.pattern_type === 'title');
            const contentPatterns = currentPatterns.filter(p => p.pattern_type === 'content');
            
            // 更新标题模式列表
            const titleTbody = document.getElementById('title_patterns_list');
            const noTitlePatterns = document.getElementById('no_title_patterns_message');
            
            titleTbody.innerHTML = '';
            
            if (titlePatterns.length > 0) {
                noTitlePatterns.style.display = 'none';
                
                titlePatterns.forEach((pattern, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><code>${pattern.pattern}</code></td>
                        <td>${pattern.priority}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="removePattern('${pattern.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    titleTbody.appendChild(tr);
                });
            } else {
                noTitlePatterns.style.display = 'block';
            }
            
            // 更新内容模式列表
            const contentTbody = document.getElementById('content_patterns_list');
            const noContentPatterns = document.getElementById('no_content_patterns_message');
            
            contentTbody.innerHTML = '';
            
            if (contentPatterns.length > 0) {
                noContentPatterns.style.display = 'none';
                
                contentPatterns.forEach((pattern, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><code>${pattern.pattern}</code></td>
                        <td>${pattern.priority}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="removePattern('${pattern.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    contentTbody.appendChild(tr);
                });
            } else {
                noContentPatterns.style.display = 'block';
            }
        }
        
        // 添加新模式
        function addPattern() {
            const pattern = document.getElementById('new_pattern').value.trim();
            const patternType = document.getElementById('new_pattern_type').value;
            const priority = parseInt(document.getElementById('new_priority').value);
            
            if (!pattern) {
                alert('请输入正则表达式');
                return;
            }
            
            // 检查是否已存在相同模式
            const existingPattern = currentPatterns.find(p => 
                p.pattern === pattern && p.pattern_type === patternType
            );
            
            if (existingPattern) {
                // 已存在相同模式，询问用户是否更新优先级
                if (confirm(`已存在相同的${patternType === 'title' ? '标题' : '内容'}正则表达式`)) {
                    ;
                }
                return;
            }
            
            // 添加到当前模式列表
            currentPatterns.push({
                pattern: pattern,
                pattern_type: patternType,
                priority: priority,
                // 临时ID，后端保存时会分配真正的ID
                id: 'temp_' + Date.now()
            });
            
            // 重新渲染列表
            renderPatternsList();
            
            // 清空输入
            document.getElementById('new_pattern').value = '';
            document.getElementById('new_priority').value = '0';
        }
        
        // 移除模式
        function removePattern(patternId) {
            const index = currentPatterns.findIndex(p => p.id.toString() === patternId.toString());
            if (index >= 0) {
                currentPatterns.splice(index, 1);
                renderPatternsList();
            }
        }

        // 保存配置
        function saveConfig() {
            // 先保存主配置
            const form = document.getElementById('configForm');
            const formData = new FormData(form);
            const configId = document.getElementById('config_id').value;
            const ruleId = document.getElementById('rule_id').value;
            
            // 确保 rule_id 被添加到表单数据中
            if (!formData.has('rule_id') && ruleId) {
                formData.append('rule_id', ruleId);
            }
            
            // 记录要提交的AI提取提示词内容，帮助调试
            const aiPrompt = document.getElementById('ai_extract_prompt').value;
            console.log('提交的AI提取提示词:', aiPrompt);
            console.log('AI提取提示词字符数:', aiPrompt.length);
            
            // 检查表单数据
            console.log('表单数据预览:');
            for (let [key, value] of formData.entries()) {
                if (key === 'ai_extract_prompt') {
                    console.log(`${key}: 字符数=${value.length}`);
                } else {
                    console.log(`${key}: ${value}`);
                }
            }
            
            fetch('/rss/config', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 配置保存成功，现在保存模式
                    const savedConfigId = data.config_id;
                    
                    // 如果没有模式，直接刷新页面
                    if (currentPatterns.length === 0) {
                        window.location.href = '/rss/dashboard?success=配置保存成功';
                        return;
                    }
                    
                    // 先清除所有现有模式，然后重新创建
                    console.log('正在清除现有模式...');
                    fetch(`/rss/patterns/${savedConfigId}`, {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(clearResult => {
                        console.log('清除模式结果:', clearResult);
                        
                        // 保存所有模式
                        const savePromises = currentPatterns.map(pattern => {
                            const patternData = new FormData();
                            patternData.append('rss_config_id', savedConfigId);
                            patternData.append('pattern', pattern.pattern);
                            patternData.append('pattern_type', pattern.pattern_type);
                            patternData.append('priority', pattern.priority);
                            
                            // 不再需要传递pattern_id，因为所有模式都是新创建的
                            
                            console.log('保存模式:', {
                                rss_config_id: savedConfigId,
                                pattern: pattern.pattern,
                                pattern_type: pattern.pattern_type,
                                priority: pattern.priority
                            });
                            
                            return fetch('/rss/pattern', {
                                method: 'POST',
                                body: patternData
                            }).then(res => res.json())
                            .then(data => {
                                if (!data.success) {
                                    throw new Error(data.message || '保存模式失败');
                                }
                                return data;
                            });
                        });
                        
                        // 等待所有模式保存完成
                        Promise.all(savePromises)
                            .then(() => {
                                window.location.href = '/rss/dashboard?success=配置和模式保存成功';
                            })
                            .catch(error => {
                                console.error('保存模式失败:', error);
                                alert('保存模式失败: ' + error.message);
                                window.location.href = '/rss/dashboard?success=配置已保存，但部分模式保存失败';
                            });
                    })
                    .catch(error => {
                        console.error('清除现有模式失败:', error);
                        alert('清除现有模式失败，将尝试直接保存新模式');
                        
                        // 保存所有模式
                        const savePromises = currentPatterns.map(pattern => {
                            const patternData = new FormData();
                            patternData.append('rss_config_id', savedConfigId);
                            patternData.append('pattern', pattern.pattern);
                            patternData.append('pattern_type', pattern.pattern_type);
                            patternData.append('priority', pattern.priority);
                            
                            // 如果是已存在的模式，添加pattern_id
                            if (pattern.id && !pattern.id.toString().startsWith('temp_')) {
                                patternData.append('pattern_id', pattern.id);
                            }
                            
                            console.log('保存模式:', {
                                rss_config_id: savedConfigId,
                                pattern: pattern.pattern,
                                pattern_type: pattern.pattern_type,
                                priority: pattern.priority,
                                pattern_id: pattern.id
                            });
                            
                            return fetch('/rss/pattern', {
                                method: 'POST',
                                body: patternData
                            }).then(res => res.json())
                            .then(data => {
                                if (!data.success) {
                                    throw new Error(data.message || '保存模式失败');
                                }
                                return data;
                            });
                        });
                        
                        // 等待所有模式保存完成
                        Promise.all(savePromises)
                            .then(() => {
                                window.location.href = '/rss/dashboard?success=配置和模式保存成功';
                            })
                            .catch(error => {
                                console.error('保存模式失败:', error);
                                alert('保存模式失败: ' + error.message);
                                window.location.href = '/rss/dashboard?success=配置已保存，但部分模式保存失败';
                            });
                    });
                } else {
                    alert(data.message || '保存配置失败');
                }
            })
            .catch(error => {
                console.error('保存配置失败:', error);
                alert('保存配置失败，请重试');
            });
        }

        // 复制配置设置到当前表单
        function copyConfigSettings() {
            const copyConfigId = parseInt(document.getElementById('copy_config').value);
            if (!copyConfigId) {
                alert('请选择一个配置进行复制');
                return;
            }
            
            const sourceConfig = configs.find(c => c.id === copyConfigId);
            if (sourceConfig) {
                // 填充表单字段，但不修改规则ID
                document.getElementById('rule_title').value = sourceConfig.rule_title;
                document.getElementById('rule_description').value = sourceConfig.rule_description;
                document.getElementById('language').value = sourceConfig.language;
                document.getElementById('max_items').value = sourceConfig.max_items;
                document.getElementById('is_auto_title').checked = sourceConfig.is_auto_title;
                document.getElementById('is_auto_content').checked = sourceConfig.is_auto_content;
                document.getElementById('is_auto_markdown_to_html').checked = sourceConfig.is_auto_markdown_to_html;
                document.getElementById('is_ai_extract').checked = sourceConfig.is_ai_extract;
                
                // 设置AI提取提示词
                if (sourceConfig.ai_extract_prompt) {
                    document.getElementById('ai_extract_prompt').value = sourceConfig.ai_extract_prompt;
                    console.log('复制的AI提取提示词:', sourceConfig.ai_extract_prompt);
                } else {
                    document.getElementById('ai_extract_prompt').value = '';
                }
                
                document.getElementById('enable_custom_title_pattern').checked = sourceConfig.enable_custom_title_pattern;
                document.getElementById('enable_custom_content_pattern').checked = sourceConfig.enable_custom_content_pattern;
                
                // 加载该配置的模式并显示成功提示
                loadPatternsForConfig(copyConfigId);
                
            }
        }

        // 测试正则表达式
        function testRegex() {
            const testPattern = document.getElementById('regex_test_pattern').value.trim();
            const testText = document.getElementById('regex_test_text').value.trim();
            const patternType = document.getElementById('regex_test_type').value;
            const resultElement = document.getElementById('regex_test_result');
            const applyButton = document.getElementById('apply_regex_btn');
            
            // 验证输入
            if (!testPattern) {
                resultElement.className = 'alert alert-warning';
                resultElement.style.display = 'block';
                resultElement.textContent = '请输入正则表达式';
                applyButton.style.display = 'none';
                return;
            }
            
            if (!testText) {
                resultElement.className = 'alert alert-warning';
                resultElement.style.display = 'block';
                resultElement.textContent = '请输入测试文本';
                applyButton.style.display = 'none';
                return;
            }
            
            // 显示加载状态
            resultElement.className = 'alert alert-info';
            resultElement.style.display = 'block';
            resultElement.innerHTML = '<i class="bi bi-hourglass-split"></i> 正在测试...';
            applyButton.style.display = 'none';
            
            // 准备表单数据
            const formData = new FormData();
            formData.append('pattern', testPattern);
            formData.append('test_text', testText);
            formData.append('pattern_type', patternType);
            
            // 发送请求
            fetch('/rss/test-regex', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (!data.matched) {
                        // 未找到匹配
                        resultElement.className = 'alert alert-warning';
                        resultElement.innerHTML = '<i class="bi bi-x-circle"></i> ' + data.message;
                        applyButton.style.display = 'none';
                    } else if (!data.has_groups) {
                        // 匹配但没有捕获组
                        resultElement.className = 'alert alert-warning';
                        resultElement.innerHTML = '<i class="bi bi-exclamation-triangle"></i> ' + data.message;
                        applyButton.style.display = 'none';
                    } else {
                        // 成功匹配并有捕获组
                        resultElement.className = 'alert alert-success';
                        resultElement.innerHTML = '<i class="bi bi-check-circle"></i> 匹配成功！<br>' +
                                                 '<strong>提取的内容:</strong> <span class="text-primary">' + 
                                                 data.extracted + '</span>';
                        
                        // 显示应用按钮
                        applyButton.style.display = 'block';
                        // 保存测试成功的正则表达式和类型到全局变量
                        window.lastSuccessfulRegex = {
                            pattern: testPattern,
                            type: patternType
                        };
                    }
                } else {
                    // 测试失败
                    resultElement.className = 'alert alert-danger';
                    resultElement.innerHTML = '<i class="bi bi-exclamation-octagon"></i> ' + data.message;
                    applyButton.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('测试正则表达式失败:', error);
                resultElement.className = 'alert alert-danger';
                resultElement.innerHTML = '<i class="bi bi-exclamation-octagon"></i> 测试失败，请查看控制台错误';
                applyButton.style.display = 'none';
            });
        }
        
        // 应用测试成功的正则表达式到输入框
        function applyTestedRegex() {
            if (!window.lastSuccessfulRegex) {
                return;
            }
            
            // 将测试成功的正则表达式填充到主表单
            document.getElementById('new_pattern').value = window.lastSuccessfulRegex.pattern;
            document.getElementById('new_pattern_type').value = window.lastSuccessfulRegex.type;
            
            // 关闭测试区域
            const bsCollapse = bootstrap.Collapse.getInstance(document.getElementById('regexTestArea'));
            if (bsCollapse) {
                bsCollapse.hide();
            }
        }

        // 设置删除确认模态框
        document.getElementById('deleteModal').addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const ruleId = button.getAttribute('data-rule-id');
            document.getElementById('deleteConfirm').href = '/rss/delete/' + ruleId;
        });

        function copyFullRssLink(ruleId) {
            // 获取完整的RSS链接
            const rssLink = getFullRssLink(ruleId);
            
            navigator.clipboard.writeText(rssLink).then(() => {
                const copySuccess = document.getElementById('copySuccess');
                copySuccess.classList.add('show');
                
                setTimeout(() => {
                    copySuccess.classList.remove('show');
                }, 2000);
            }).catch(err => {
                console.error('复制失败:', err);
                alert('复制失败，请手动复制');
            });
        }
        
        // 生成完整的RSS链接（使用服务器配置或当前域名）
        function getFullRssLink(ruleId) {
            // 使用服务器端提供的配置（如果存在）或当前域名
            const baseUrl = '{{ rss_base_url }}' || window.location.origin;
            return `${baseUrl}/rss/feed/${ruleId}`;
        }

        // 页面加载后更新所有RSS链接显示完整URL
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('[id^="rss-link-"]').forEach(element => {
                const ruleId = element.id.replace('rss-link-', '');
                const fullLink = getFullRssLink(ruleId);
                element.textContent = fullLink;
            });
            
            // 初始化时禁用已配置的规则ID
            disableConfiguredRules();
        });

        function autoFillTitle() {
            const ruleSelect = document.getElementById('rule_id');
            // 检查是否有选中的选项
            if (ruleSelect.selectedIndex > 0) {
                // 获取选中选项的文本，格式为 "ID - 源名称 → 目标名称"
                const selectedText = ruleSelect.options[ruleSelect.selectedIndex].text;
                
                // 使用正则表达式提取源聊天名称（箭头前面的部分）
                const match = selectedText.match(/\d+\s*-\s*([^→]+)→/);
                if (match && match[1]) {
                    // 设置RSS标题为"来自 源聊天名称"
                    const sourceName = match[1].trim();
                    document.getElementById('rule_title').value = `来自 ${sourceName}`;
                }
            } else {
                alert('请先选择一个规则');
            }
        }

        // 修改密码
        function changePassword() {
            const currentPassword = document.getElementById('current_password').value;
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            const errorElement = document.getElementById('password_error');
            
            // 清除之前的错误信息
            errorElement.style.display = 'none';
            
            // 基本验证
            if (!currentPassword) {
                errorElement.textContent = '请输入当前密码';
                errorElement.style.display = 'block';
                return;
            }
            
            if (!newPassword) {
                errorElement.textContent = '请输入新密码';
                errorElement.style.display = 'block';
                return;
            }
            
            if (newPassword.length < 8) {
                errorElement.textContent = '新密码长度必须至少为8个字符';
                errorElement.style.display = 'block';
                return;
            }
            
            if (newPassword !== confirmPassword) {
                errorElement.textContent = '新密码和确认密码不一致';
                errorElement.style.display = 'block';
                return;
            }
            
            // 提交表单数据
            const formData = new FormData();
            formData.append('current_password', currentPassword);
            formData.append('new_password', newPassword);
            formData.append('confirm_password', confirmPassword);
            
            fetch('/rss/change_password', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 显示成功消息并关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                    modal.hide();
                    
                    // 清空表单
                    document.getElementById('changePasswordForm').reset();
                    
                    // 显示全局成功消息（重用复制成功的提示框）
                    const successElement = document.getElementById('copySuccess');
                    successElement.textContent = '密码修改成功';
                    successElement.classList.add('show');
                    
                    setTimeout(() => {
                        successElement.classList.remove('show');
                    }, 2000);
                } else {
                    // 显示错误消息
                    errorElement.textContent = data.message || '修改密码失败';
                    errorElement.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('修改密码失败:', error);
                errorElement.textContent = '修改密码请求失败，请重试';
                errorElement.style.display = 'block';
            });
        }
    </script>
</body>
</html> 